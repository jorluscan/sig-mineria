{% extends 'base.html' %}
{% load humanize %}
{% load static %}

{% block content %}
<div class="space-y-6 fade-in pb-10">

  <div class="grid grid-cols-1 gap-6">
    <div class="bg-white p-5 rounded-lg border border-slate-200 shadow-sm flex items-center justify-between">
      <div>
        <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Estado de Insumos Críticos</p>
        <div class="flex items-baseline gap-3 mt-1">
          <h3 class="text-3xl font-bold text-slate-800">{{ critical_products|length }}</h3>
          <span class="text-sm text-slate-500 font-medium">alertas activas en monitoreo</span>
        </div>
        <div class="mt-3">
          {% if critical_products %}
          <span
            class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-amber-50 text-amber-700 border border-amber-100 font-bold text-xs">
            <i class="fas fa-circle-exclamation"></i> Requieren Atención Inmediata
          </span>
          {% else %}
          <span
            class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-100 font-bold text-xs">
            <i class="fas fa-check-circle"></i> Operación Estable y Segura
          </span>
          {% endif %}
        </div>
      </div>
      <div
        class="p-4 rounded-full {% if critical_products %}bg-amber-50 text-amber-500{% else %}bg-emerald-50 text-emerald-500{% endif %}">
        <i
          class="fas {% if critical_products %}fa-triangle-exclamation{% else %}fa-shield-halved{% endif %} text-3xl"></i>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

    <div class="bg-white p-6 rounded-lg border border-slate-200 shadow-sm lg:col-span-1 flex flex-col">
      <h3 class="font-bold text-slate-700 text-xs uppercase mb-4 tracking-wide">Distribución por Familia</h3>
      <div class="flex-1 relative min-h-[200px]">
        <canvas id="categoryChart"></canvas>
      </div>
    </div>

    <div class="bg-white p-0 rounded-lg border border-slate-200 shadow-sm lg:col-span-2 overflow-hidden flex flex-col">
      <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
        <div class="flex items-center gap-3">
          <h3 class="font-bold text-slate-800 text-sm flex items-center gap-2">
            <i class="fas fa-flask text-purple-500"></i>
            Monitor de Insumos Críticos
          </h3>
        </div>

        <div class="flex gap-2">
          <button onclick="printCriticalReport()"
            class="text-xs bg-white border border-slate-300 text-slate-600 hover:text-slate-800 hover:bg-slate-50 font-bold px-3 py-1.5 rounded-md transition-colors flex items-center gap-2 shadow-sm">
            <i class="fas fa-print"></i> Imprimir Reporte
          </button>
          <a href="{% url 'inventory_list' %}"
            class="text-xs bg-blue-600 text-white hover:bg-blue-700 font-bold px-3 py-1.5 rounded-md transition-colors flex items-center gap-2 shadow-sm">
            Ver Todo
          </a>
        </div>
      </div>

      <div id="printableArea" class="overflow-x-auto flex-1">
        <table class="w-full text-left text-sm">
          <thead class="bg-white text-slate-500 text-xs uppercase font-semibold border-b border-slate-100">
            <tr>
              <th class="px-6 py-3">Insumo / Reactivo</th>
              <th class="px-6 py-3 text-center">Stock Actual</th>
              <th class="px-6 py-3 text-center">Autonomía Est.</th>
              <th class="px-6 py-3 text-right">Estado</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-50">
            {% for product in critical_products %}
            <tr class="hover:bg-slate-50 transition-colors">
              <td class="px-6 py-3">
                <div class="flex items-center">
                  <div class="mr-3">
                    {% if product.stock_status == 'OUT_OF_STOCK' %}
                    <div class="h-2 w-2 rounded-full bg-red-600"></div>
                    {% elif product.stock_status == 'CRITICAL' %}
                    <div class="h-2 w-2 rounded-full bg-red-500"></div>
                    {% elif product.stock_status == 'LOW' %}
                    <div class="h-2 w-2 rounded-full bg-amber-400"></div>
                    {% else %}
                    <div class="h-2 w-2 rounded-full bg-emerald-500"></div>
                    {% endif %}
                  </div>
                  <div>
                    <span class="block font-bold text-slate-700 text-sm">{{ product.name }}</span>
                    <span class="text-[10px] text-slate-400 uppercase font-medium">
                      Consumo: {{ product.daily_usage_rate|floatformat:0 }} {{ product.unit_of_measure }}/día
                    </span>
                  </div>
                </div>
              </td>

              <td class="px-6 py-3 text-center">
                <span class="font-mono font-bold text-slate-700">{{ product.total_stock|intcomma }}</span>
                <span class="text-[10px] font-sans text-slate-400 ml-1">{{ product.unit_of_measure }}</span>
              </td>

              <td class="px-6 py-3 text-center">
                {% if product.stock_status == 'OUT_OF_STOCK' %}
                <span class="text-xs font-bold text-red-600">DETENIDO</span>
                {% else %}
                <span class="font-bold text-slate-700 block">{{ product.estimated_days_remaining }} días</span>
                {% endif %}
              </td>
              <td class="px-6 py-3 text-right">
                {% if product.stock_status == 'OUT_OF_STOCK' %}
                <span class="text-xs font-bold text-red-800">AGOTADO</span>
                {% elif product.stock_status == 'CRITICAL' %}
                <span class="text-xs font-bold text-red-600">CRÍTICO</span>
                {% elif product.stock_status == 'LOW' %}
                <span class="text-xs font-bold text-amber-600">BAJO</span>
                {% else %}
                <span class="text-xs font-bold text-emerald-600">OK</span>
                {% endif %}
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="4" class="p-4 text-center text-xs text-slate-400">Sin alertas activas</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">

    <div class="bg-white rounded-lg border border-slate-200 shadow-sm overflow-hidden">
      <div class="px-6 py-3 border-b border-slate-100 bg-slate-50/50 flex items-center justify-between">
        <h3 class="font-bold text-emerald-800 text-xs uppercase tracking-wider">Últimos Ingresos</h3>
        <i class="fas fa-arrow-down text-emerald-500"></i>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full text-sm text-left border-collapse">
          <thead class="text-xs text-slate-400 uppercase bg-white border-b border-slate-100">
            <tr>
              <th class="px-6 py-3 font-medium bg-white">Material</th>
              <th class="px-6 py-3 font-bold text-center bg-emerald-50 text-emerald-700 border-x border-emerald-100">
                CANT.</th>
              <th class="px-6 py-3 font-medium text-right bg-white">Fecha</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-50">
            {% for arrival in recent_arrivals %}
            <tr class="hover:bg-slate-50">
              <td class="px-6 py-3 bg-white">
                <span class="font-semibold text-slate-700 block">{{ arrival.variation.product.name }}</span>
                <span class="text-[10px] text-slate-400 uppercase">{{ arrival.supplier|default:'General' }}</span>
              </td>
              <td class="px-6 py-3 text-center bg-emerald-50 border-x border-emerald-100">
                <span class="text-emerald-700 font-black text-xs block">+{{ arrival.quantity|intcomma }}</span>
              </td>
              <td class="px-6 py-3 text-right text-slate-500 font-mono text-xs bg-white">
                {{ arrival.arrival_date|date:"d/m H:i" }}
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="3" class="p-4 text-center text-xs text-slate-400">Sin ingresos</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <div class="bg-white rounded-lg border border-slate-200 shadow-sm overflow-hidden">
      <div class="px-6 py-3 border-b border-slate-100 bg-slate-50/50 flex items-center justify-between">
        <h3 class="font-bold text-amber-800 text-xs uppercase tracking-wider">Últimos Despachos</h3>
        <i class="fas fa-arrow-up text-amber-500"></i>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full text-sm text-left">
          <thead class="text-xs text-slate-400 uppercase bg-white border-b border-slate-100">
            <tr>
              <th class="px-6 py-3 font-medium bg-white">Material</th>
              <th class="px-6 py-3 font-bold text-center bg-amber-50 text-amber-700 border-x border-amber-100">CANT.
              </th>
              <th class="px-6 py-3 font-medium text-right bg-white">Destino</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-50">
            {% for dispatch in recent_dispatches %}
            <tr class="hover:bg-slate-50">
              <td class="px-6 py-3 bg-white">
                <span class="font-semibold text-slate-700 block">{{ dispatch.variation.product.name }}</span>
                <span class="text-[10px] text-slate-400 uppercase">{{ dispatch.user.username|default:'Sistema' }}</span>
              </td>
              <td class="px-6 py-3 text-center bg-amber-50 border-x border-amber-100">
                <span class="text-amber-700 font-black text-xs block">-{{ dispatch.quantity|intcomma }}</span>
              </td>
              <td class="px-6 py-3 text-right text-slate-500 text-xs font-medium bg-white">
                {{ dispatch.destination|truncatechars:15 }}
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="3" class="p-4 text-center text-xs text-slate-400">Sin despachos</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<script>
  // 1. Script del Gráfico
  Chart.register(ChartDataLabels);
  const industrialPalette = ['#475569', '#eab308', '#ef4444', '#22c55e', '#3b82f6', '#a855f7', '#f97316', '#06b6d4'];
  const ctx = document.getElementById('categoryChart').getContext('2d');
  new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: {{ cat_labels| safe }},
    datasets: [{
      data: {{ cat_stocks| safe }},
    backgroundColor: industrialPalette,
    borderWidth: 2,
    borderColor: '#ffffff',
    hoverOffset: 4
      }]
    },
    options: {
    responsive: true,
    maintainAspectRatio: false,
    cutout: '70%',
    plugins: {
      legend: { position: 'right', labels: { font: { size: 10, family: 'Inter', weight: '500' }, boxWidth: 10, usePointStyle: true, color: '#64748b' } },
      datalabels: { display: false }
    }
  }
  });

  // 2. Script de Impresión de Reporte
  function printCriticalReport() {
    var printContents = document.getElementById("printableArea").innerHTML;
    var today = new Date();
    var dateStr = today.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    var timeStr = today.toLocaleTimeString('es-ES');
    var win = window.open('', '', 'height=700,width=900');

    win.document.write('<html><head><title>Reporte de Críticos</title>');
    win.document.write(`
        <style>
            body { font-family: sans-serif; padding: 20px; color: #1e293b; }
            h1 { font-size: 18px; text-transform: uppercase; margin-bottom: 5px; color: #0f172a; border-bottom: 2px solid #0f172a; padding-bottom: 10px; }
            .meta { font-size: 12px; color: #64748b; margin-bottom: 20px; }
            table { width: 100%; border-collapse: collapse; font-size: 12px; }
            th { text-align: left; border-bottom: 1px solid #cbd5e1; padding: 8px; background-color: #f1f5f9; text-transform: uppercase; font-size: 10px; }
            td { border-bottom: 1px solid #e2e8f0; padding: 8px; vertical-align: middle; }
            .text-center { text-align: center; }
            .text-right { text-align: right; }
            .w-24, .h-1.5, .rounded-full { display: none; } 
        </style>
    `);
    win.document.write('</head><body>');
    win.document.write('<h1>Reporte de Insumos Críticos - Planta Beneficio</h1>');
    win.document.write('<div class="meta">Generado el: ' + dateStr + ' a las ' + timeStr + '</div>');
    win.document.write(printContents);
    win.document.write('<div style="margin-top:30px; border-top:1px solid #ccc; padding-top:10px; font-size:10px; text-align:center;">SIG - Sistema de Gestión de Inventarios</div>');
    win.document.write('</body></html>');
    win.document.close();
    win.print();
  }
</script>
{% endblock %}