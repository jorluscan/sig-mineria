{% extends 'base.html' %} {% load humanize %} {% block content %}
<div class="fade-in">
  <div class="mb-10">
    <h1 class="font-serif text-4xl text-zinc-900 leading-tight">
      Resumen Global
    </h1>
    <p class="text-zinc-600 text-[10px] uppercase tracking-[0.4em] mt-2 font-bold">
      Panel de Inteligencia Gestión de Inventario
    </p>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
    <div class="bg-white p-6 rounded-3xl border border-zinc-200 shadow-sm">
      <span class="text-[9px] uppercase tracking-widest text-zinc-600 font-bold block mb-2">Inversión en Stock</span>
      <p class="text-2xl font-serif text-zinc-900">
        ${{ total_cost|floatformat:2|intcomma }}
      </p>
      <div class="mt-2 text-[10px] text-zinc-500 italic">
        <i class="fas fa-wallet mr-2 text-gold"></i> Capital Actual
      </div>
    </div>

    <div class="bg-white p-6 rounded-3xl border border-zinc-200 shadow-sm">
      <span class="text-[9px] uppercase tracking-widest text-zinc-600 font-bold block mb-2">Valor de Venta</span>
      <p class="text-2xl font-serif text-zinc-900">
        ${{ total_sales_value|floatformat:2|intcomma }}
      </p>
      <div class="mt-2 text-[10px] text-zinc-500 italic">
        <i class="fas fa-tag mr-2 text-gold"></i> Ingreso Estimado
      </div>
    </div>

    <div class="p-6 rounded-3xl bg-zinc-900 border-none shadow-sm">
      <span class="text-[9px] uppercase tracking-widest text-zinc-400 font-bold block mb-2">Utilidad Bruta</span>
      <p class="text-2xl font-serif text-gold">
        ${{ projected_profit|floatformat:2|intcomma }}
      </p>
      <div class="mt-2 text-[10px] text-zinc-500 italic">
        <i class="fas fa-chart-line mr-2"></i> Margen Ganancia
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-12">

    <div class="bg-white p-8 rounded-3xl border border-zinc-200 shadow-sm flex flex-col items-center">
      <h3 class="font-serif text-xl text-zinc-800 mb-6 self-start">
        Composición del Inventario
      </h3>
      <div class="w-full relative" style="height: 300px">
        <canvas id="categoryChart"></canvas>
      </div>
    </div>

    <div class="lg:col-span-2 bg-white p-8 rounded-3xl border border-zinc-200 shadow-sm overflow-hidden">
      <h3 class="font-serif text-xl text-zinc-800 mb-6">Últimos Movimientos Detallados</h3>

      <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
        <div>
          <p class="text-[10px] uppercase font-bold text-zinc-400 tracking-widest border-b border-zinc-100 pb-2 mb-4">
            Ingresos (Entradas)
          </p>
          <div class="overflow-x-auto">
            <table class="w-full text-left">
              <thead>
                <tr class="text-[9px] uppercase text-zinc-400">
                  <th class="pb-2">Producto</th>
                  <th class="pb-2 text-center">Cant.</th>
                  <th class="pb-2 text-right">Monto</th>
                  <th class="pb-2 text-right px-2">Ref.</th>
                </tr>
              </thead>
              <tbody class="text-[11px]">
                {% for arrival in recent_arrivals %}
                <tr class="border-b border-zinc-50 hover:bg-zinc-50 transition-colors">
                  <td class="py-2">
                    <span class="font-bold text-zinc-800 block">{{ arrival.variation.product.name }}</span>
                    <span class="text-[9px] text-zinc-500">{{ arrival.arrival_date|date:"d/m H:i" }}</span>
                  </td>
                  <td class="py-2 text-center text-green-600 font-bold">+{{ arrival.quantity }}</td>
                  <td class="py-2 text-right font-medium">${{ arrival.total_value|floatformat:0|intcomma }}</td>
                  <td class="py-2 text-right text-zinc-400 px-2">
                    <i class="fas fa-user-circle text-[10px]" title="{{ arrival.user.username|default:'Admin' }}"></i>
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="4" class="py-4 text-zinc-400 italic text-center">Sin ingresos recientes.</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        <div>
          <p class="text-[10px] uppercase font-bold text-zinc-400 tracking-widest border-b border-zinc-100 pb-2 mb-4">
            Despachos (Salidas)
          </p>
          <div class="overflow-x-auto">
            <table class="w-full text-left">
              <thead>
                <tr class="text-[9px] uppercase text-zinc-400">
                  <th class="pb-2">Producto</th>
                  <th class="pb-2 text-center">Cant.</th>
                  <th class="pb-2 text-right">Monto</th>
                  <th class="pb-2 text-right px-2">Ref.</th>
                </tr>
              </thead>
              <tbody class="text-[11px]">
                {% for dispatch in recent_dispatches %}
                <tr class="border-b border-zinc-50 hover:bg-zinc-50 transition-colors">
                  <td class="py-2">
                    <span class="font-bold text-zinc-800 block">{{ dispatch.variation.product.name }}</span>
                    <span class="text-[9px] text-zinc-500">{{ dispatch.dispatched_at|date:"d/m H:i" }}</span>
                  </td>
                  <td class="py-2 text-center text-amber-600 font-bold">-{{ dispatch.quantity }}</td>
                  <td class="py-2 text-right font-medium">${{ dispatch.total_value|floatformat:0|intcomma }}</td>
                  <td class="py-2 text-right text-zinc-400 px-2">
                    <i class="fas fa-user-circle text-[10px]" title="{{ dispatch.user.username|default:'Admin' }}"></i>
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="4" class="py-4 text-zinc-400 italic text-center">Sin despachos recientes.</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<script>
  Chart.register(ChartDataLabels);

  const ctx = document.getElementById('categoryChart').getContext('2d');
  new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: {{ cat_labels| safe }},
    datasets: [{
      data: {{ cat_stocks| safe }},
    backgroundColor: ['#d4af37', '#18181b', '#71717a', '#a1a1aa', '#3f3f46'],
    borderWidth: 2,
    borderColor: '#ffffff'
      }]
    },
    options: {
    responsive: true,
    maintainAspectRatio: false,
    cutout: '65%',
    plugins: {
      legend: {
        position: 'bottom',
        labels: {
          font: { size: 10, family: 'Inter', weight: 'bold' },
          padding: 20,
          usePointStyle: true
        }
      },
      tooltip: {
        callbacks: {
          label: function (context) {
            let label = context.label || '';
            let value = context.raw || 0;
            // Forzar formato en-US (Coma para miles, Punto para decimal)
            let formattedValue = new Intl.NumberFormat('en-US').format(value);
            return `${label}: ${formattedValue} unidades`;
          }
        }
      },
      datalabels: {
        color: '#fff',
        font: { family: 'Inter', weight: 'bold', size: 11 },
        formatter: (value, ctx) => {
          let sum = 0;
          let dataArr = ctx.chart.data.datasets[0].data;
          dataArr.map(data => { sum += data; });
          return (value * 100 / sum).toFixed(1) + "%";
        },
        display: (ctx) => {
          let dataset = ctx.dataset.data;
          let sum = dataset.reduce((a, b) => a + b, 0);
          let value = dataset[ctx.dataIndex];
          return (value * 100 / sum) > 3;
        }
      }
    }
  }
  });
</script>
{% endblock %}