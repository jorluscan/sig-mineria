{% extends 'base.html' %}
{% load humanize %}

{% block content %}
<div class="fade-in max-w-7xl mx-auto pb-20">

  <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
    <div>
      <h1 class="text-2xl font-bold text-slate-800">Maestro de Materiales</h1>
      <p class="text-xs text-slate-500 font-medium">Gestión centralizada de insumos y repuestos</p>
    </div>

    <div class="flex gap-2 w-full md:w-auto">
      <form method="GET" class="relative w-full md:w-80">
        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
        <input type="text" name="q" value="{{ query }}" placeholder="Buscar por código, nombre o tipo..."
          class="w-full pl-10 pr-4 py-2 bg-white border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none transition-shadow shadow-sm">
      </form>

      <a href="{% url 'create_dispatch' %}"
        class="px-4 py-2 bg-blue-600 text-white text-sm font-bold rounded-lg hover:bg-blue-700 shadow-sm transition-colors flex items-center gap-2">
        <i class="fas fa-dolly"></i> <span class="hidden sm:inline">Salida</span>
      </a>
      <a href="{% url 'create_stock_arrival' %}"
        class="px-4 py-2 bg-emerald-600 text-white text-sm font-bold rounded-lg hover:bg-emerald-700 shadow-sm transition-colors flex items-center gap-2">
        <i class="fas fa-truck-loading"></i> <span class="hidden sm:inline">Entrada</span>
      </a>
      <a href="{% url 'create_product' %}"
        class="px-4 py-2 bg-white border border-slate-300 text-slate-700 text-sm font-bold rounded-lg hover:bg-slate-50 shadow-sm transition-colors flex items-center gap-2">
        <i class="fas fa-plus"></i> <span class="hidden sm:inline">Nuevo</span>
      </a>
    </div>
  </div>

  <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
    <div class="overflow-x-auto">
      <table class="w-full text-left border-collapse">
        <thead class="bg-slate-50 border-b border-slate-200">
          <tr class="text-xs font-bold text-slate-500 uppercase tracking-wider">
            <th class="px-6 py-4 cursor-pointer hover:text-slate-700">
              <a href="?o={% if request.GET.o == 'sku' %}-sku{% else %}sku{% endif %}&q={{ query }}">
                Código / SKU <i class="fas fa-sort ml-1 opacity-50"></i>
              </a>
            </th>
            <th class="px-6 py-4 cursor-pointer hover:text-slate-700">
              <a href="?o={% if request.GET.o == 'name' %}-name{% else %}name{% endif %}&q={{ query }}">
                Descripción Material <i class="fas fa-sort ml-1 opacity-50"></i>
              </a>
            </th>
            <th class="px-6 py-4 text-center">Unidad & Consumo</th>

            <th class="px-6 py-4 text-center">Autonomía Est.</th>

            <th class="px-6 py-4 text-center cursor-pointer hover:text-slate-700">
              <a href="?o={% if request.GET.o == 'stock' %}-stock{% else %}stock{% endif %}&q={{ query }}">
                Existencia Física <i class="fas fa-sort ml-1 opacity-50"></i>
              </a>
            </th>
            <th class="px-6 py-4 text-right">Opciones</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-100 text-sm">
          {% for product in products %}
          <tr class="hover:bg-slate-50 transition-colors group">

            <td class="px-6 py-4">
              <span
                class="font-mono font-bold text-slate-600 bg-slate-100 px-2 py-1 rounded text-xs border border-slate-200">
                {{ product.sku }}
              </span>
            </td>

            <td class="px-6 py-4">
              <div class="flex flex-col">
                <span class="font-bold text-slate-800 text-sm group-hover:text-blue-600 transition-colors">
                  {{ product.name }}
                </span>
                <div class="flex items-center gap-2 mt-1">
                  <span class="text-[10px] uppercase font-bold text-slate-400">
                    <i class="fas fa-tag mr-1"></i>{{ product.category.name|default:"General" }}
                  </span>
                  {% if product.is_critical %}
                  <span class="text-[9px] uppercase font-black text-white bg-red-500 px-1.5 rounded-sm">Crítico</span>
                  {% endif %}
                </div>
              </div>
            </td>

            <td class="px-6 py-4 text-center">
              <div class="flex flex-col items-center">
                <span class="font-bold text-slate-600 text-xs bg-slate-100 px-2 py-0.5 rounded-full mb-1">
                  {{ product.unit_of_measure }}
                </span>
                {% if product.daily_usage_rate > 0 %}
                <span class="text-[10px] text-slate-400">
                  <i class="fas fa-fire text-amber-500 mr-1"></i>{{ product.daily_usage_rate|floatformat:1 }}/día
                </span>
                {% else %}
                <span class="text-[10px] text-slate-300 italic">Sin consumo reg.</span>
                {% endif %}
              </div>
            </td>

            <td class="px-6 py-4 text-center">
              {% if product.total_qty == 0 %}
              <span class="text-xs font-bold text-red-500 bg-red-50 px-2 py-1 rounded">Agotado</span>
              {% elif product.estimated_days_remaining < 7 %} <div
                class="flex items-center justify-center gap-1 text-red-600 font-bold">
                <i class="fas fa-clock"></i> {{ product.estimated_days_remaining }} días
    </div>
    {% elif product.estimated_days_remaining < 15 %} <div
      class="flex items-center justify-center gap-1 text-amber-600 font-bold">
      <i class="fas fa-clock"></i> {{ product.estimated_days_remaining }} días
  </div>
  {% else %}
  <div class="flex items-center justify-center gap-1 text-emerald-600 font-bold">
    <i class="fas fa-infinity text-xs"></i> > 30 días
  </div>
  {% endif %}
  </td>

  <td class="px-6 py-4 text-center">
    {% if product.total_qty <= product.min_stock_level %} <span
      class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-bold bg-red-50 text-red-600 border border-red-100 animate-pulse">
      <i class="fas fa-triangle-exclamation"></i> {{ product.total_qty|intcomma }}
      </span>
      {% elif product.total_qty <= product.min_stock_level|add:product.min_stock_level %} <span
        class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-bold bg-amber-50 text-amber-600 border border-amber-100">
        {{ product.total_qty|intcomma }}
        </span>
        {% else %}
        <span
          class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-emerald-50 text-emerald-600 border border-emerald-100">
          {{ product.total_qty|intcomma }}
        </span>
        {% endif %}
  </td>

  <td class="px-6 py-4 text-right">
    <div class="flex items-center justify-end gap-2">
      <a href="{% url 'product_detail' product.id %}"
        class="p-2 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-full transition-all" title="Ver Detalle">
        <i class="fas fa-eye"></i>
      </a>
      <a href="#" class="p-2 text-slate-400 hover:text-amber-600 hover:bg-amber-50 rounded-full transition-all"
        title="Editar (Próximamente)">
        <i class="fas fa-pen"></i>
      </a>
    </div>
  </td>

  </tr>
  {% empty %}
  <tr>
    <td colspan="6" class="px-6 py-12 text-center">
      <div class="flex flex-col items-center justify-center text-slate-400">
        <div class="bg-slate-50 p-4 rounded-full mb-3">
          <i class="fas fa-box-open text-3xl"></i>
        </div>
        <p class="text-base font-medium text-slate-600">No se encontraron materiales</p>
        <p class="text-xs">Intenta con otro término de búsqueda o registra un nuevo ítem.</p>
      </div>
    </td>
  </tr>
  {% endfor %}
  </tbody>
  </table>
</div>

<div class="bg-slate-50 px-6 py-3 border-t border-slate-200 flex justify-between items-center">
  <span class="text-xs text-slate-500">Mostrando {{ products|length }} ítems</span>
  <div class="flex gap-1">
    <button class="px-3 py-1 border border-slate-300 rounded bg-white text-xs text-slate-600 disabled:opacity-50"
      disabled>Ant.</button>
    <button class="px-3 py-1 border border-slate-300 rounded bg-white text-xs text-slate-600 disabled:opacity-50"
      disabled>Sig.</button>
  </div>
</div>
</div>
</div>
{% endblock %}